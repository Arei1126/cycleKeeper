<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mood Cycle Tracker</title>
	<meta name="description" content="ã‚·ãƒ³ãƒ—ãƒ«ãªèºé¬±å‘¨æœŸç®¡ç†ãƒ»è¨˜éŒ²ã‚¢ãƒ—ãƒª">
	
	<!-- PWAè¨­å®š -->
	<meta name="theme-color" content="#f0f2f5">
	<meta name="apple-mobile-web-app-capable" content="yes">

	<style>
		:root {
			/* ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼å®šç¾© */
			--bg-color: #f0f2f5;
			--card-bg: #ffffff;
			--text-main: #333333;
			--text-sub: #666666;
			--accent: #6200ea;
			--border: #e0e0e0;
			
			/* æ°—åˆ†ã‚«ãƒ©ãƒ¼ */
			--mood-manic-high: #ff5252;
			--mood-manic-mid: #ff8a80;
			--mood-flat: #e0e0e0;
			--mood-dep-mid: #90caf9;
			--mood-dep-high: #2979ff;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
		}

		body {
			background-color: var(--bg-color);
			color: var(--text-main);
			padding-bottom: 80px;
		}

		/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
		header {
			background: var(--card-bg);
			padding: 1rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
			position: sticky;
			top: 0;
			z-index: 10;
		}

		h1 {
			font-size: 1.2rem;
			font-weight: bold;
		}

		.header-controls button {
			background: none;
			border: 1px solid var(--border);
			padding: 0.5rem 1rem;
			border-radius: 4px;
			cursor: pointer;
			font-size: 1rem;
		}

		/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
		.calendar-container {
			max-width: 800px;
			margin: 1rem auto;
			padding: 0 1rem;
		}

		.month-nav {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}

		.month-label {
			font-size: 1.5rem;
			font-weight: bold;
		}

		.calendar-grid {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			gap: 4px;
			background: var(--border);
			border: 1px solid var(--border);
			border-radius: 8px;
			overflow: hidden;
		}

		.weekday {
			background: var(--card-bg);
			text-align: center;
			padding: 0.5rem 0;
			font-weight: bold;
			font-size: 0.8rem;
			color: var(--text-sub);
		}
		.weekday:nth-child(7n), .weekday:nth-child(7n+1) {
			color: #ff5252;
		}

		.day-cell {
			background: var(--card-bg);
			min-height: 80px;
			padding: 4px;
			position: relative;
			cursor: pointer;
			display: flex;
			flex-direction: column;
			transition: background-color 0.2s;
		}

		.day-cell:active {
			filter: brightness(0.9);
		}

		.day-number {
			font-size: 0.9rem;
			font-weight: bold;
			margin-bottom: 4px;
		}

		.day-today {
			background-color: #e3f2fd;
		}

		.mood-indicator {
			flex-grow: 1;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2rem;
			color: white;
			text-shadow: 0 1px 2px rgba(0,0,0,0.3);
			position: relative;
		}

		/* ç¡çœ æ™‚é–“ã®ãƒãƒƒã‚¸è¡¨ç¤º */
		.sleep-badge {
			position: absolute;
			bottom: 2px;
			right: 2px;
			font-size: 0.6rem;
			background: rgba(255,255,255,0.8);
			color: #333;
			padding: 1px 3px;
			border-radius: 3px;
			font-weight: bold;
			box-shadow: 0 1px 2px rgba(0,0,0,0.1);
		}

		/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.5);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 100;
		}

		.modal-content {
			background: var(--card-bg);
			width: 90%;
			max-width: 500px;
			border-radius: 12px;
			padding: 1.5rem;
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
			max-height: 90vh;
			overflow-y: auto;
		}

		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1.5rem;
		}

		.form-group {
			margin-bottom: 1.5rem;
			border-bottom: 1px solid #f0f0f0;
			padding-bottom: 1rem;
		}
		.form-group:last-of-type {
			border-bottom: none;
		}

		label {
			display: block;
			margin-bottom: 0.5rem;
			font-weight: bold;
			color: var(--text-sub);
		}
		
		.sub-label {
			font-size: 0.9rem;
			color: var(--text-main);
			margin-bottom: 0.2rem;
		}

		/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å…±é€š */
		input[type="range"] {
			width: 100%;
			height: 8px;
			border-radius: 4px;
			outline: none;
			-webkit-appearance: none;
			margin: 10px 0;
			background: #e0e0e0;
		}
		
		/* æ°—åˆ†ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å°‚ç”¨è‰² */
		#moodRange {
			background: linear-gradient(to right, var(--mood-dep-high), var(--mood-flat), var(--mood-manic-high));
		}

		input[type="range"]::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 24px;
			height: 24px;
			background: #fff;
			border: 2px solid var(--text-sub);
			border-radius: 50%;
			cursor: pointer;
			box-shadow: 0 2px 4px rgba(0,0,0,0.2);
		}

		.mood-value-display, .sleep-summary {
			text-align: center;
			font-size: 1.1rem;
			margin-top: 0.5rem;
			font-weight: bold;
		}
		
		.sleep-control {
			margin-bottom: 1rem;
		}

		textarea {
			width: 100%;
			padding: 0.8rem;
			border: 1px solid var(--border);
			border-radius: 6px;
			resize: vertical;
			min-height: 80px;
			font-size: 1rem;
		}

		.modal-actions {
			display: flex;
			gap: 1rem;
			justify-content: flex-end;
			margin-top: 1rem;
		}

		.btn {
			padding: 0.8rem 1.5rem;
			border: none;
			border-radius: 6px;
			font-weight: bold;
			cursor: pointer;
			font-size: 1rem;
		}

		.btn-cancel {
			background: #f5f5f5;
			color: var(--text-main);
		}

		.btn-save {
			background: var(--accent);
			color: white;
		}

		.export-area {
			text-align: center;
			margin-top: 2rem;
			padding: 1rem;
			border-top: 1px solid var(--border);
		}
		
		.hidden {
			display: none;
		}

	</style>
</head>
<body>

<header>
	<h1>Mood Tracker ğŸ§ </h1>
	<div class="header-controls">
		<button id="todayBtn">ä»Šæ—¥</button>
	</div>
</header>

<div class="calendar-container">
	<div class="month-nav">
		<button class="btn btn-cancel" id="prevMonth">â† å‰æœˆ</button>
		<div class="month-label" id="currentMonthLabel">Loading...</div>
		<button class="btn btn-cancel" id="nextMonth">ç¿Œæœˆ â†’</button>
	</div>

	<div class="calendar-grid" id="calendarGrid">
		<!-- JSã§ã“ã“ã‚’åŸ‹ã‚ã‚‹ -->
	</div>
</div>

<div class="export-area">
	<button class="btn btn-cancel" onclick="exportData()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ä¿å­˜</button>
	<p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">â€»ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™</p>
</div>

<!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="entryModal">
	<div class="modal-content">
		<div class="modal-header">
			<h2 id="modalDateLabel">æ—¥ä»˜</h2>
			<button class="btn btn-cancel" style="padding:0.5rem;" onclick="closeModal()">âœ•</button>
		</div>

		<!-- æ°—åˆ†å…¥åŠ› -->
		<div class="form-group">
			<label>ä»Šæ—¥ã®æ°—åˆ† (Mood)</label>
			<input type="range" id="moodRange" min="-5" max="5" step="1" value="0">
			<div class="mood-value-display" id="moodValueDisplay">ãƒ•ãƒ©ãƒƒãƒˆ (0)</div>
			<div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#666; margin-top:4px;">
				<span>é¬± (-5)</span>
				<span>èº (+5)</span>
			</div>
		</div>

		<!-- ç¡çœ å…¥åŠ› (æ–°æ©Ÿèƒ½) -->
		<div class="form-group">
			<label>ç¡çœ è¨˜éŒ² (Sleep)</label>
			<div class="sleep-control">
				<label class="sub-label">ğŸ›Œ å°±å¯ (Bedtime): <span id="sleepStartDisplay">23:00</span></label>
				<!-- 0ã€œ1425 (23æ™‚é–“45åˆ†) step15 -->
				<input type="range" id="sleepStartRange" min="0" max="1425" step="15" value="1380">
			</div>
			
			<div class="sleep-control">
				<label class="sub-label">ğŸŒ… èµ·åºŠ (Wake-up): <span id="sleepEndDisplay">07:00</span></label>
				<input type="range" id="sleepEndRange" min="0" max="1425" step="15" value="420">
			</div>

			<div class="sleep-summary">
				è¨ˆ: <span id="sleepDurationDisplay" style="color:var(--accent);">8.0</span> æ™‚é–“
			</div>
		</div>

		<!-- ãƒ¡ãƒ¢å…¥åŠ› -->
		<div class="form-group">
			<label>ãƒ¡ãƒ¢ (Note)</label>
			<textarea id="memoInput" placeholder="å‡ºæ¥äº‹ã€è–¬ã®æœç”¨ã€ãƒˆãƒªã‚¬ãƒ¼ãªã©..."></textarea>
		</div>

		<div class="modal-actions">
			<button class="btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
			<button class="btn btn-save" onclick="saveEntry()">ä¿å­˜ã™ã‚‹</button>
		</div>
	</div>
</div>

<script>
	/**
	 * çŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•°
	 */
	let currentDisplayDate = new Date();
	let selectedDateStr = null;

	// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆæœŸåŒ–å‡¦ç†
	document.addEventListener('DOMContentLoaded', () => {
		renderCalendar();
		setupEventListeners();
	});

	/**
	 * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ä¸€æ‹¬è¨­å®š
	 */
	function setupEventListeners() {
		document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
		document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
		document.getElementById('todayBtn').addEventListener('click', () => {
			currentDisplayDate = new Date();
			renderCalendar();
		});

		// æ°—åˆ†ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
		const moodRange = document.getElementById('moodRange');
		moodRange.addEventListener('input', (e) => updateMoodLabel(parseInt(e.target.value)));

		// ç¡çœ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ (Start/End ä¸¡æ–¹ã§åŒã˜æ›´æ–°é–¢æ•°ã‚’å‘¼ã¶)
		const sleepStartRange = document.getElementById('sleepStartRange');
		const sleepEndRange = document.getElementById('sleepEndRange');
		
		const updateSleep = () => updateSleepDisplay(parseInt(sleepStartRange.value), parseInt(sleepEndRange.value));
		sleepStartRange.addEventListener('input', updateSleep);
		sleepEndRange.addEventListener('input', updateSleep);

		// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
		document.getElementById('entryModal').addEventListener('click', (e) => {
			if (e.target === document.getElementById('entryModal')) closeModal();
		});
	}

	/**
	 * åˆ†(0-1439)ã‚’ HH:MM å½¢å¼ã«å¤‰æ›
	 */
	function formatTime(minutes) {
		const h = Math.floor(minutes / 60);
		const m = minutes % 60;
		return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
	}

	/**
	 * ç¡çœ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
	 */
	function updateSleepDisplay(startVal, endVal) {
		document.getElementById('sleepStartDisplay').textContent = formatTime(startVal);
		document.getElementById('sleepEndDisplay').textContent = formatTime(endVal);

		// ç¡çœ æ™‚é–“è¨ˆç®— (æ—¥è·¨ãè€ƒæ…®)
		// ä¾‹: 23:00(1380)å°±å¯ -> 07:00(420)èµ·åºŠ = (1440-1380) + 420 = 500åˆ†
		let durationMinutes = endVal - startVal;
		if (durationMinutes < 0) {
			durationMinutes += 1440; // 24æ™‚é–“åˆ†è¶³ã™
		}
		
		const durationHours = (durationMinutes / 60).toFixed(1);
		document.getElementById('sleepDurationDisplay').textContent = durationHours;
	}

	/**
	 * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
	 */
	function renderCalendar() {
		const grid = document.getElementById('calendarGrid');
		const label = document.getElementById('currentMonthLabel');
		
		grid.innerHTML = '';
		
		const year = currentDisplayDate.getFullYear();
		const month = currentDisplayDate.getMonth();
		
		label.textContent = `${year}å¹´ ${month + 1}æœˆ`;

		const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
		weekdays.forEach(day => {
			const div = document.createElement('div');
			div.className = 'weekday';
			div.textContent = day;
			grid.appendChild(div);
		});

		const firstDay = new Date(year, month, 1);
		const lastDay = new Date(year, month + 1, 0);
		const startDayOfWeek = firstDay.getDay();
		const totalDays = lastDay.getDate();

		// ç©ºç™½åŸ‹ã‚
		for (let i = 0; i < startDayOfWeek; i++) {
			const blank = document.createElement('div');
			blank.style.background = '#f9f9f9';
			grid.appendChild(blank);
		}

		// æ—¥ä»˜ã‚»ãƒ«ç”Ÿæˆ
		const todayStr = new Date().toISOString().split('T')[0];
		
		for (let day = 1; day <= totalDays; day++) {
			const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
			
			const cell = document.createElement('div');
			cell.className = 'day-cell';
			if (dateKey === todayStr) cell.classList.add('day-today');

			const num = document.createElement('div');
			num.className = 'day-number';
			num.textContent = day;
			cell.appendChild(num);

			const data = loadData(dateKey);
			if (data) {
				const moodIndicator = document.createElement('div');
				moodIndicator.className = 'mood-indicator';
				moodIndicator.style.backgroundColor = getMoodColor(data.mood);
				moodIndicator.textContent = getMoodEmoji(data.mood);
				
				// ç¡çœ æ™‚é–“ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚Œã°ãƒãƒƒã‚¸è¡¨ç¤º (æ–°æ©Ÿèƒ½)
				if (data.sleepDuration) {
					const badge = document.createElement('div');
					badge.className = 'sleep-badge';
					badge.textContent = `${data.sleepDuration}h`;
					moodIndicator.appendChild(badge);
				}

				cell.appendChild(moodIndicator);
			}

			cell.addEventListener('click', () => openModal(dateKey));
			grid.appendChild(cell);
		}
	}

	function changeMonth(step) {
		currentDisplayDate.setMonth(currentDisplayDate.getMonth() + step);
		renderCalendar();
	}

	function loadData(dateKey) {
		const raw = localStorage.getItem(`bipolar_app_${dateKey}`);
		return raw ? JSON.parse(raw) : null;
	}

	/**
	 * ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (ç¡çœ ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ )
	 */
	function saveEntry() {
		if (!selectedDateStr) return;

		const moodVal = parseInt(document.getElementById('moodRange').value);
		const memoVal = document.getElementById('memoInput').value;
		
		// ç¡çœ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
		const startVal = parseInt(document.getElementById('sleepStartRange').value);
		const endVal = parseInt(document.getElementById('sleepEndRange').value);
		const durationText = document.getElementById('sleepDurationDisplay').textContent;

		const data = {
			mood: moodVal,
			memo: memoVal,
			// ã“ã“ã§äº’æ›æ€§ã®ãŸã‚ã«æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
			sleepStart: startVal,
			sleepEnd: endVal,
			sleepDuration: durationText,
			timestamp: new Date().toISOString()
		};

		localStorage.setItem(`bipolar_app_${selectedDateStr}`, JSON.stringify(data));
		
		closeModal();
		renderCalendar();
	}

	/**
	 * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã (ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨åˆæœŸå€¤è¨­å®š)
	 */
	function openModal(dateKey) {
		selectedDateStr = dateKey;
		const data = loadData(dateKey);

		document.getElementById('entryModal').style.display = 'flex';
		document.getElementById('modalDateLabel').textContent = dateKey;

		if (data) {
			// æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
			document.getElementById('moodRange').value = data.mood;
			document.getElementById('memoInput').value = data.memo || '';
			updateMoodLabel(data.mood);

			// ç¡çœ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ (å¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã¯ç„¡ã„ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š)
			// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: å°±å¯23:00(1380), èµ·åºŠ07:00(420)
			const sStart = data.sleepStart !== undefined ? data.sleepStart : 1380;
			const sEnd = data.sleepEnd !== undefined ? data.sleepEnd : 420;
			
			document.getElementById('sleepStartRange').value = sStart;
			document.getElementById('sleepEndRange').value = sEnd;
			updateSleepDisplay(sStart, sEnd);

		} else {
			// æ–°è¦ã®å ´åˆ
			document.getElementById('moodRange').value = 0;
			document.getElementById('memoInput').value = '';
			updateMoodLabel(0);
			
			// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
			document.getElementById('sleepStartRange').value = 1380; // 23:00
			document.getElementById('sleepEndRange').value = 420;  // 07:00
			updateSleepDisplay(1380, 420);
		}
	}

	function closeModal() {
		document.getElementById('entryModal').style.display = 'none';
		selectedDateStr = null;
	}

	function updateMoodLabel(val) {
		const display = document.getElementById('moodValueDisplay');
		let text = `ãƒ•ãƒ©ãƒƒãƒˆ (${val})`;
		if (val > 0) text = `èºå¯„ã‚Š (+${val})`;
		if (val < 0) text = `é¬±å¯„ã‚Š (${val})`;
		display.textContent = text;
		display.style.color = getMoodColor(val);
	}

	function getMoodColor(val) {
		if (val === 0) return '#9e9e9e';
		if (val > 0) return val >= 3 ? '#ff1744' : '#ff8a80';
		return val <= -3 ? '#2979ff' : '#90caf9';
	}

	function getMoodEmoji(val) {
		if (val >= 4) return 'ğŸ”¥';
		if (val >= 2) return 'ğŸ˜¤';
		if (val >= 1) return 'ğŸ™‚';
		if (val === 0) return 'ğŸ˜';
		if (val >= -1) return 'â˜ï¸';
		if (val >= -3) return 'ğŸ’§';
		return 'â˜”ï¸';
	}

	/**
	 * CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (ç¡çœ ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ)
	 */
	function exportData() {
		// ãƒ˜ãƒƒãƒ€ãƒ¼ã«ç¡çœ é–¢ä¿‚ã‚’è¿½åŠ 
		let csvContent = "data:text/csv;charset=utf-8,Date,Mood,SleepDuration(h),Bedtime,Wakeup,Memo\n";
		
		const keys = Object.keys(localStorage).filter(k => k.startsWith('bipolar_app_')).sort();
		
		if (keys.length === 0) {
			alert("ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼");
			return;
		}

		keys.forEach(key => {
			const date = key.replace('bipolar_app_', '');
			const data = JSON.parse(localStorage.getItem(key));
			
			const safeMemo = `"${(data.memo || '').replace(/"/g, '""')}"`;
			
			// ç¡çœ ãƒ‡ãƒ¼ã‚¿ãŒãªã„å¤ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã¸ã®å¯¾å¿œ
			const duration = data.sleepDuration || "";
			const bedtime = data.sleepStart !== undefined ? formatTime(data.sleepStart) : "";
			const wakeup = data.sleepEnd !== undefined ? formatTime(data.sleepEnd) : "";

			csvContent += `${date},${data.mood},${duration},${bedtime},${wakeup},${safeMemo}\n`;
		});

		const encodedUri = encodeURI(csvContent);
		const link = document.createElement("a");
		link.setAttribute("href", encodedUri);
		link.setAttribute("download", "mood_sleep_data.csv");
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
	}
	
	// PWAç”¨ Service Workerç™»éŒ² (å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤)
	/*
	if ('serviceWorker' in navigator) {
		window.addEventListener('load', function() {
			navigator.serviceWorker.register('/sw.js');
		});
	}
	*/
</script>
</body>
</html>
