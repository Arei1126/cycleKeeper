<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mood Cycle Tracker</title>
	<meta name="description" content="ã‚·ãƒ³ãƒ—ãƒ«ãªèºé¬±å‘¨æœŸç®¡ç†ãƒ»è¨˜éŒ²ã‚¢ãƒ—ãƒª">
	
	<!-- PWAç”¨è¨­å®šï¼ˆå¾Œã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã‚‰æœ‰åŠ¹åŒ–ã™ã‚‹æƒ³å®šï¼‰ -->
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#f0f2f5">
	<meta name="apple-mobile-web-app-capable" content="yes">

	<style>
		:root {
			/* ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼å®šç¾© */
			--bg-color: #f0f2f5;
			--card-bg: #ffffff;
			--text-main: #333333;
			--text-sub: #666666;
			--accent: #6200ea;
			--border: #e0e0e0;
			
			/* æ°—åˆ†ã‚«ãƒ©ãƒ¼ï¼ˆ-5:é‡ã„é¬± ã€œ 0:ãƒ•ãƒ©ãƒƒãƒˆ ã€œ +5:æ¿€ã—ã„èºï¼‰ */
			--mood-manic-high: #ff5252;
			--mood-manic-mid: #ff8a80;
			--mood-flat: #e0e0e0;
			--mood-dep-mid: #90caf9;
			--mood-dep-high: #2979ff;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
		}

		body {
			background-color: var(--bg-color);
			color: var(--text-main);
			padding-bottom: 80px; /* ãƒ•ãƒƒã‚¿ãƒ¼ç”¨ã‚¹ãƒšãƒ¼ã‚¹ */
		}

		/* ãƒ˜ãƒƒãƒ€ãƒ¼å‘¨ã‚Š */
		header {
			background: var(--card-bg);
			padding: 1rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			display: flex;
			justify-content: space-between;
			align-items: center;
			position: sticky;
			top: 0;
			z-index: 10;
		}

		h1 {
			font-size: 1.2rem;
			font-weight: bold;
		}

		.header-controls button {
			background: none;
			border: 1px solid var(--border);
			padding: 0.5rem 1rem;
			border-radius: 4px;
			cursor: pointer;
			font-size: 1rem;
		}

		/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ */
		.calendar-container {
			max-width: 800px;
			margin: 1rem auto;
			padding: 0 1rem;
		}

		.month-nav {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}

		.month-label {
			font-size: 1.5rem;
			font-weight: bold;
		}

		.calendar-grid {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			gap: 4px;
			background: var(--border);
			border: 1px solid var(--border);
			border-radius: 8px;
			overflow: hidden;
		}

		.weekday {
			background: var(--card-bg);
			text-align: center;
			padding: 0.5rem 0;
			font-weight: bold;
			font-size: 0.8rem;
			color: var(--text-sub);
		}
		.weekday:nth-child(7n), .weekday:nth-child(7n+1) {
			color: #ff5252; /* åœŸæ—¥ã¯èµ¤ã£ã½ã */
		}

		.day-cell {
			background: var(--card-bg);
			min-height: 80px;
			padding: 4px;
			position: relative;
			cursor: pointer;
			display: flex;
			flex-direction: column;
			transition: background-color 0.2s;
		}

		.day-cell:active {
			filter: brightness(0.9);
		}

		.day-number {
			font-size: 0.9rem;
			font-weight: bold;
			margin-bottom: 4px;
		}

		.day-today {
			background-color: #e3f2fd; /* ä»Šæ—¥ã®å¼·èª¿ */
		}

		.mood-indicator {
			flex-grow: 1;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2rem;
			color: white;
			text-shadow: 0 1px 2px rgba(0,0,0,0.3);
		}

		/* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…¥åŠ›ç”»é¢ï¼‰ */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.5);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 100;
		}

		.modal-content {
			background: var(--card-bg);
			width: 90%;
			max-width: 500px;
			border-radius: 12px;
			padding: 1.5rem;
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
			max-height: 90vh;
			overflow-y: auto;
		}

		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1.5rem;
		}

		.form-group {
			margin-bottom: 1.5rem;
		}

		label {
			display: block;
			margin-bottom: 0.5rem;
			font-weight: bold;
			color: var(--text-sub);
		}

		/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
		input[type="range"] {
			width: 100%;
			height: 8px;
			background: linear-gradient(to right, var(--mood-dep-high), var(--mood-flat), var(--mood-manic-high));
			border-radius: 4px;
			outline: none;
			-webkit-appearance: none;
		}
		input[type="range"]::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 24px;
			height: 24px;
			background: #fff;
			border: 2px solid var(--text-sub);
			border-radius: 50%;
			cursor: pointer;
			box-shadow: 0 2px 4px rgba(0,0,0,0.2);
		}

		.mood-value-display {
			text-align: center;
			font-size: 1.2rem;
			margin-top: 0.5rem;
			font-weight: bold;
		}

		textarea {
			width: 100%;
			padding: 0.8rem;
			border: 1px solid var(--border);
			border-radius: 6px;
			resize: vertical;
			min-height: 100px;
			font-size: 1rem;
		}

		.modal-actions {
			display: flex;
			gap: 1rem;
			justify-content: flex-end;
		}

		.btn {
			padding: 0.8rem 1.5rem;
			border: none;
			border-radius: 6px;
			font-weight: bold;
			cursor: pointer;
			font-size: 1rem;
		}

		.btn-cancel {
			background: #f5f5f5;
			color: var(--text-main);
		}

		.btn-save {
			background: var(--accent);
			color: white;
		}

		.export-area {
			text-align: center;
			margin-top: 2rem;
			padding: 1rem;
			border-top: 1px solid var(--border);
		}
		
		/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
		.hidden {
			display: none;
		}

	</style>
</head>
<body>

<header>
	<h1>Mood Tracker ğŸ§ </h1>
	<div class="header-controls">
		<button id="todayBtn">ä»Šæ—¥</button>
	</div>
</header>

<div class="calendar-container">
	<div class="month-nav">
		<button class="btn btn-cancel" id="prevMonth">â† å‰æœˆ</button>
		<div class="month-label" id="currentMonthLabel">2023å¹´ 10æœˆ</div>
		<button class="btn btn-cancel" id="nextMonth">ç¿Œæœˆ â†’</button>
	</div>

	<div class="calendar-grid" id="calendarGrid">
		<!-- JSã§ã“ã“ã‚’åŸ‹ã‚ã‚‹ -->
	</div>
</div>

<div class="export-area">
	<button class="btn btn-cancel" onclick="exportData()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ä¿å­˜</button>
	<p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">â€»ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™</p>
</div>

<!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="entryModal">
	<div class="modal-content">
		<div class="modal-header">
			<h2 id="modalDateLabel">10æœˆ27æ—¥</h2>
			<button class="btn btn-cancel" style="padding:0.5rem;" onclick="closeModal()">âœ•</button>
		</div>

		<div class="form-group">
			<label>ä»Šæ—¥ã®æ°—åˆ† (Mood)</label>
			<input type="range" id="moodRange" min="-5" max="5" step="1" value="0">
			<div class="mood-value-display" id="moodValueDisplay">ãƒ•ãƒ©ãƒƒãƒˆ (0)</div>
			<div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#666; margin-top:4px;">
				<span>é¬± (-5)</span>
				<span>èº (+5)</span>
			</div>
		</div>

		<div class="form-group">
			<label>ãƒ¡ãƒ¢ (å‡ºæ¥äº‹ãƒ»ç¡çœ ãƒ»è–¬ãªã©)</label>
			<textarea id="memoInput" placeholder="ç¡çœ æ™‚é–“ã€æœè–¬çŠ¶æ³ã€ãƒˆãƒªã‚¬ãƒ¼ã«ãªã£ãŸå‡ºæ¥äº‹ãªã©ã‚’è¨˜å…¥..."></textarea>
		</div>

		<div class="modal-actions">
			<button class="btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
			<button class="btn btn-save" onclick="saveEntry()">ä¿å­˜ã™ã‚‹</button>
		</div>
	</div>
</div>

<script>
	/**
	 * çŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•°
	 * currentDisplayDate: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºä¸­ã®å¹´æœˆ
	 * selectedDate: ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç·¨é›†ä¸­ãªã©ã®æ—¥ä»˜æ–‡å­—åˆ— (YYYY-MM-DD)
	 */
	let currentDisplayDate = new Date();
	let selectedDateStr = null;

	// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆæœŸåŒ–å‡¦ç†
	document.addEventListener('DOMContentLoaded', () => {
		renderCalendar();
		setupEventListeners();
	});

	/**
	 * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ä¸€æ‹¬è¨­å®š
	 */
	function setupEventListeners() {
		document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
		document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
		document.getElementById('todayBtn').addEventListener('click', () => {
			currentDisplayDate = new Date();
			renderCalendar();
		});

		// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ãŒå¤‰ã‚ã£ãŸã‚‰ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
		const moodRange = document.getElementById('moodRange');
		moodRange.addEventListener('input', (e) => {
			updateMoodLabel(parseInt(e.target.value));
		});

		// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
		document.getElementById('entryModal').addEventListener('click', (e) => {
			if (e.target === document.getElementById('entryModal')) {
				closeModal();
			}
		});
	}

	/**
	 * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
	 * é–å¹´ã‚„æœˆã¾ãŸãã®è¨ˆç®—ã‚’è¡Œã„ã€DOMã‚’ç”Ÿæˆã™ã‚‹
	 */
	function renderCalendar() {
		const grid = document.getElementById('calendarGrid');
		const label = document.getElementById('currentMonthLabel');
		
		grid.innerHTML = ''; // ã‚¯ãƒªã‚¢
		
		const year = currentDisplayDate.getFullYear();
		const month = currentDisplayDate.getMonth(); // 0-11
		
		// ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›´æ–°
		label.textContent = `${year}å¹´ ${month + 1}æœˆ`;

		// æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
		const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
		weekdays.forEach(day => {
			const div = document.createElement('div');
			div.className = 'weekday';
			div.textContent = day;
			grid.appendChild(div);
		});

		// æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’å–å¾—
		const firstDay = new Date(year, month, 1);
		const lastDay = new Date(year, month + 1, 0); // ç¿Œæœˆã®0æ—¥ç›® = ä»Šæœˆã®æœ«æ—¥
		
		const startDayOfWeek = firstDay.getDay(); // 0(æ—¥) - 6(åœŸ)
		const totalDays = lastDay.getDate();

		// å‰æœˆã®ç©ºç™½åŸ‹ã‚
		for (let i = 0; i < startDayOfWeek; i++) {
			const blank = document.createElement('div');
			blank.style.background = '#f9f9f9'; // ç©ºç™½ã‚»ãƒ«
			grid.appendChild(blank);
		}

		// æ—¥ä»˜ã‚»ãƒ«ç”Ÿæˆ
		const todayStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
		
		for (let day = 1; day <= totalDays; day++) {
			// YYYY-MM-DDå½¢å¼ã®ã‚­ãƒ¼ç”Ÿæˆ
			const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
			
			const cell = document.createElement('div');
			cell.className = 'day-cell';
			if (dateKey === todayStr) {
				cell.classList.add('day-today');
			}

			// æ—¥ä»˜æ•°å­—
			const num = document.createElement('div');
			num.className = 'day-number';
			num.textContent = day;
			cell.appendChild(num);

			// ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¡¨ç¤º
			const data = loadData(dateKey);
			if (data) {
				const moodIndicator = document.createElement('div');
				moodIndicator.className = 'mood-indicator';
				moodIndicator.style.backgroundColor = getMoodColor(data.mood);
				
				// æ°—åˆ†ã«å¿œã˜ãŸçµµæ–‡å­—ã‚’è¡¨ç¤ºï¼ˆè¦–èªæ€§å‘ä¸Šï¼‰
				moodIndicator.textContent = getMoodEmoji(data.mood);
				
				// ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯å°ã•ã„ãƒ‰ãƒƒãƒˆãªã©ã‚’è¡¨ç¤ºã—ã¦ã‚‚è‰¯ã„ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«è‰²ã¨çµµæ–‡å­—ã§è¡¨ç¾
				cell.appendChild(moodIndicator);
			}

			// ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
			cell.addEventListener('click', () => openModal(dateKey));
			grid.appendChild(cell);
		}
	}

	/**
	 * æœˆã®ç§»å‹•å‡¦ç†
	 */
	function changeMonth(step) {
		currentDisplayDate.setMonth(currentDisplayDate.getMonth() + step);
		renderCalendar();
	}

	/**
	 * LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
	 */
	function loadData(dateKey) {
		const raw = localStorage.getItem(`bipolar_app_${dateKey}`);
		return raw ? JSON.parse(raw) : null;
	}

	/**
	 * ãƒ‡ãƒ¼ã‚¿ä¿å­˜
	 */
	function saveEntry() {
		if (!selectedDateStr) return;

		const moodVal = parseInt(document.getElementById('moodRange').value);
		const memoVal = document.getElementById('memoInput').value;

		const data = {
			mood: moodVal,
			memo: memoVal,
			timestamp: new Date().toISOString()
		};

		localStorage.setItem(`bipolar_app_${selectedDateStr}`, JSON.stringify(data));
		
		closeModal();
		renderCalendar(); // ç”»é¢æ›´æ–°
	}

	/**
	 * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
	 */
	function openModal(dateKey) {
		selectedDateStr = dateKey;
		const data = loadData(dateKey);

		document.getElementById('entryModal').style.display = 'flex';
		document.getElementById('modalDateLabel').textContent = dateKey;

		// ãƒ‡ãƒ¼ã‚¿ã®å……å¡«ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆ
		if (data) {
			document.getElementById('moodRange').value = data.mood;
			document.getElementById('memoInput').value = data.memo || '';
			updateMoodLabel(data.mood);
		} else {
			document.getElementById('moodRange').value = 0;
			document.getElementById('memoInput').value = '';
			updateMoodLabel(0);
		}
	}

	/**
	 * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
	 */
	function closeModal() {
		document.getElementById('entryModal').style.display = 'none';
		selectedDateStr = null;
	}

	/**
	 * æ°—åˆ†å€¤ã®ãƒ©ãƒ™ãƒ«æ›´æ–°
	 */
	function updateMoodLabel(val) {
		const display = document.getElementById('moodValueDisplay');
		let text = `ãƒ•ãƒ©ãƒƒãƒˆ (${val})`;
		if (val > 0) text = `èºå¯„ã‚Š (+${val})`;
		if (val < 0) text = `é¬±å¯„ã‚Š (${val})`;
		display.textContent = text;
		display.style.color = getMoodColor(val);
	}

	/**
	 * æ°—åˆ†ã«å¿œã˜ãŸè‰²ã‚’è¿”ã™
	 */
	function getMoodColor(val) {
		if (val === 0) return '#9e9e9e'; // ã‚°ãƒ¬ãƒ¼
		if (val > 0) {
			// èµ¤ç³»ï¼ˆèºï¼‰
			// å€¤ãŒé«˜ã„ã»ã©æ¿ƒã„èµ¤ã«ã—ãŸã„ãŒã€CSSå¤‰æ•°ã§ç°¡æ˜“åŒ–
			return val >= 3 ? '#ff1744' : '#ff8a80'; 
		} else {
			// é’ç³»ï¼ˆé¬±ï¼‰
			return val <= -3 ? '#2979ff' : '#90caf9';
		}
	}

	/**
	 * æ°—åˆ†ã«å¿œã˜ãŸçµµæ–‡å­—ã‚’è¿”ã™
	 */
	function getMoodEmoji(val) {
		if (val >= 4) return 'ğŸ”¥'; // æ¿€ã—ã„èº
		if (val >= 2) return 'ğŸ˜¤'; // è»½èº
		if (val >= 1) return 'ğŸ™‚'; // å…ƒæ°—
		if (val === 0) return 'ğŸ˜'; // æ™®é€š
		if (val >= -1) return 'â˜ï¸'; // æ›‡ã‚Š
		if (val >= -3) return 'ğŸ’§'; // è½ã¡è¾¼ã¿
		return 'â˜”ï¸'; // é‡ã„é¬±
	}

	/**
	 * CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
	 * LocalStorageã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èµ°æŸ»ã—ã¦CSVåŒ–ã™ã‚‹
	 */
	function exportData() {
		let csvContent = "data:text/csv;charset=utf-8,Date,Mood,Memo\n";
		
		// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼ã‚’å…¨ã¦ãƒã‚§ãƒƒã‚¯
		const keys = Object.keys(localStorage).filter(k => k.startsWith('bipolar_app_')).sort();
		
		if (keys.length === 0) {
			alert("ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼");
			return;
		}

		keys.forEach(key => {
			const date = key.replace('bipolar_app_', '');
			const data = JSON.parse(localStorage.getItem(key));
			// ãƒ¡ãƒ¢å†…ã®æ”¹è¡Œã‚„ã‚«ãƒ³ãƒã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
			const safeMemo = `"${(data.memo || '').replace(/"/g, '""')}"`;
			csvContent += `${date},${data.mood},${safeMemo}\n`;
		});

		const encodedUri = encodeURI(csvContent);
		const link = document.createElement("a");
		link.setAttribute("href", encodedUri);
		link.setAttribute("download", "mood_data.csv");
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
	}

	// ---------------------------------------------------------
	// ã“ã“ã‹ã‚‰å…ˆã¯PWAåŒ–ã®ãŸã‚ã®Service Workerç™»éŒ²ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã®é››å½¢
	// Github Pagesã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã¯ã€w.jsã‚’ä½œæˆã—ã¦ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã™
	// ---------------------------------------------------------
	if ('serviceWorker' in navigator) {
		window.addEventListener('load', function() {
			navigator.serviceWorker.register('/sw.js').then(function(registration) {
				console.log('ServiceWorker registration successful with scope: ', registration.scope);
			}, function(err) {
				console.log('ServiceWorker registration failed: ', err);
			});
		});
	}

</script>
</body>
</html>
