<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mood Cycle Tracker</title>
	<meta name="description" content="ã‚·ãƒ³ãƒ—ãƒ«ãªèºé¬±å‘¨æœŸç®¡ç†ãƒ»è¨˜éŒ²ã‚¢ãƒ—ãƒª">
	
	<!-- PWAè¨­å®š -->
	<meta name="theme-color" content="#f0f2f5">
	<meta name="apple-mobile-web-app-capable" content="yes">

	<style>
		:root {
			--bg-color: #f0f2f5;
			--card-bg: #ffffff;
			--text-main: #333333;
			--text-sub: #666666;
			--accent: #6200ea;
			--border: #e0e0e0;
			
			/* æ°—åˆ†ã‚«ãƒ©ãƒ¼ */
			--mood-manic-high: #ff5252;
			--mood-flat: #9e9e9e;
			--mood-dep-high: #2979ff;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
		}

		body {
			background-color: var(--bg-color);
			color: var(--text-main);
			padding-bottom: 80px;
		}

		/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
		header {
			background: var(--card-bg);
			padding: 1rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			position: sticky;
			top: 0;
			z-index: 10;
		}

		.nav-tabs {
			display: flex;
			justify-content: center;
			gap: 1rem;
			margin-top: 1rem;
		}

		.tab-btn {
			padding: 0.5rem 1.5rem;
			border: none;
			background: none;
			font-weight: bold;
			color: var(--text-sub);
			cursor: pointer;
			border-bottom: 3px solid transparent;
		}

		.tab-btn.active {
			color: var(--accent);
			border-bottom-color: var(--accent);
		}

		/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
		main {
			max-width: 800px;
			margin: 0 auto;
			padding: 1rem;
		}

		.view-section {
			display: none;
		}

		.view-section.active {
			display: block;
		}

		/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º */
		.month-nav {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}

		.calendar-grid {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			gap: 4px;
			background: var(--border);
			border: 1px solid var(--border);
			border-radius: 8px;
			overflow: hidden;
		}

		.weekday {
			background: var(--card-bg);
			text-align: center;
			padding: 0.5rem 0;
			font-weight: bold;
			font-size: 0.8rem;
			color: var(--text-sub);
		}

		.day-cell {
			background: var(--card-bg);
			min-height: 80px;
			padding: 4px;
			cursor: pointer;
			display: flex;
			flex-direction: column;
		}

		.day-number { font-size: 0.9rem; font-weight: bold; }
		.day-today { background-color: #e3f2fd; }

		.mood-indicator {
			flex-grow: 1;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.2rem;
			color: white;
			position: relative;
		}

		.sleep-badge {
			position: absolute;
			bottom: 2px;
			right: 2px;
			font-size: 0.6rem;
			background: rgba(255,255,255,0.8);
			color: #333;
			padding: 1px 3px;
			border-radius: 3px;
		}

		/* åˆ†æè¡¨ç¤ºï¼ˆã‚°ãƒ©ãƒ•ï¼‰ */
		.chart-card {
			background: var(--card-bg);
			padding: 1rem;
			border-radius: 12px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
			margin-bottom: 1rem;
		}

		canvas {
			width: 100%;
			height: auto;
			display: block;
		}

		.insight-box {
			background: #fdfcf0;
			border-left: 4px solid #f9a825;
			padding: 1rem;
			border-radius: 4px;
			margin-top: 1rem;
		}

		/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.5);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 100;
		}

		.modal-content {
			background: var(--card-bg);
			width: 90%;
			max-width: 500px;
			border-radius: 12px;
			padding: 1.5rem;
			max-height: 90vh;
			overflow-y: auto;
		}

		.form-group {
			margin-bottom: 1.5rem;
			border-bottom: 1px solid #f0f0f0;
			padding-bottom: 1rem;
		}

		input[type="range"] {
			width: 100%;
			height: 8px;
			background: #e0e0e0;
			border-radius: 4px;
			-webkit-appearance: none;
			margin: 15px 0;
		}
		
		#moodRange { background: linear-gradient(to right, var(--mood-dep-high), var(--mood-flat), var(--mood-manic-high)); }
		
		input[type="range"]::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 26px;
			height: 26px;
			background: #fff;
			border: 2px solid var(--accent);
			border-radius: 50%;
			box-shadow: 0 2px 4px rgba(0,0,0,0.2);
		}

		textarea {
			width: 100%;
			padding: 0.8rem;
			border: 1px solid var(--border);
			border-radius: 6px;
			min-height: 80px;
		}

		.btn { padding: 0.8rem 1.5rem; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
		.btn-save { background: var(--accent); color: white; }
		.btn-cancel { background: #f5f5f5; color: var(--text-main); }

		.footer-actions { text-align: center; margin-top: 2rem; }
	</style>
</head>
<body>

<header>
	<h1 style="text-align:center;">Mood Cycle Tracker ğŸ§ </h1>
	<nav class="nav-tabs">
		<button class="tab-btn active" onclick="switchView('calendar')">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
		<button class="tab-btn" onclick="switchView('stats')">åˆ†æãƒ»ã‚°ãƒ©ãƒ•</button>
	</nav>
</header>

<main>
	<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ -->
	<section id="calendarView" class="view-section active">
		<div class="month-nav">
			<button class="btn btn-cancel" onclick="changeMonth(-1)">â†</button>
			<h2 id="currentMonthLabel">Loading...</h2>
			<button class="btn btn-cancel" onclick="changeMonth(1)">â†’</button>
		</div>
		<div class="calendar-grid" id="calendarGrid"></div>
		
		<div class="footer-actions">
			<button class="btn btn-cancel" onclick="exportData()">ğŸ’¾ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
		</div>
	</section>

	<!-- åˆ†æãƒ“ãƒ¥ãƒ¼ -->
	<section id="statsView" class="view-section">
		<div class="chart-card">
			<h3 style="margin-bottom:1rem;">ç›´è¿‘30æ—¥ã®å‚¾å‘</h3>
			<canvas id="moodChart" height="250"></canvas>
			<div style="display:flex; justify-content:center; gap:1rem; font-size:0.8rem; margin-top:0.5rem;">
				<span style="color:var(--accent);">â— æ°—åˆ† (æŠ˜ã‚Œç·š)</span>
				<span style="color:#bdbdbd;">â–  ç¡çœ æ™‚é–“ (æ£’)</span>
			</div>
		</div>

		<div class="insight-box" id="insightBox">
			<h4 style="margin-bottom:0.5rem;">ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h4>
			<p id="insightText">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
		</div>
	</section>
</main>

<!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="entryModal">
	<div class="modal-content">
		<h2 id="modalDateLabel" style="margin-bottom:1.5rem;">æ—¥ä»˜</h2>
		
		<div class="form-group">
			<label>ä»Šæ—¥ã®æ°—åˆ†</label>
			<input type="range" id="moodRange" min="-5" max="5" step="1" value="0">
			<div id="moodValueDisplay" style="text-align:center; font-weight:bold;">ãƒ•ãƒ©ãƒƒãƒˆ (0)</div>
		</div>

		<div class="form-group">
			<label>ç¡çœ æ™‚é–“</label>
			<div style="font-size:0.9rem; color:var(--text-sub);">
				å°±å¯: <span id="sleepStartDisplay">ç¿Œ01:00</span> / èµ·åºŠ: <span id="sleepEndDisplay">ç¿Œ09:00</span>
			</div>
			<input type="range" id="sleepStartRange" min="0" max="2880" step="15" value="1500">
			<input type="range" id="sleepEndRange" min="0" max="2880" step="15" value="1980">
			<div style="text-align:center; font-weight:bold;">è¨ˆ: <span id="sleepDurationDisplay">8.0</span> æ™‚é–“</div>
		</div>

		<div class="form-group">
			<label>ãƒ¡ãƒ¢</label>
			<textarea id="memoInput" placeholder="å‡ºæ¥äº‹ã‚„è–¬ãªã©..."></textarea>
		</div>

		<div style="display:flex; gap:1rem; justify-content:flex-end;">
			<button class="btn btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
			<button class="btn btn-save" onclick="saveEntry()">ä¿å­˜</button>
		</div>
	</div>
</div>

<script>
	let currentDisplayDate = new Date();
	let selectedDateStr = null;

	document.addEventListener('DOMContentLoaded', () => {
		renderCalendar();
		setupEventListeners();
	});

	function setupEventListeners() {
		document.getElementById('moodRange').addEventListener('input', e => updateMoodLabel(parseInt(e.target.value)));
		const updateSleep = () => updateSleepDisplay(
			parseInt(document.getElementById('sleepStartRange').value),
			parseInt(document.getElementById('sleepEndRange').value)
		);
		document.getElementById('sleepStartRange').addEventListener('input', updateSleep);
		document.getElementById('sleepEndRange').addEventListener('input', updateSleep);
		document.getElementById('entryModal').addEventListener('click', e => {
			if(e.target === document.getElementById('entryModal')) closeModal();
		});
	}

	function switchView(viewName) {
		document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
		document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
		
		document.getElementById(viewName + 'View').classList.add('active');
		document.querySelector(`.tab-btn[onclick*="${viewName}"]`).classList.add('active');

		if (viewName === 'stats') renderChart();
	}

	function formatTime(min) {
		const h = Math.floor(min / 60);
		const m = min % 60;
		return (h >= 24 ? 'ç¿Œ' : '') + `${String(h % 24).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
	}

	function updateSleepDisplay(start, end) {
		document.getElementById('sleepStartDisplay').textContent = formatTime(start);
		document.getElementById('sleepEndDisplay').textContent = formatTime(end);
		const duration = Math.max(0, (end - start) / 60).toFixed(1);
		document.getElementById('sleepDurationDisplay').textContent = duration;
	}

	function updateMoodLabel(val) {
		const label = val === 0 ? 'ãƒ•ãƒ©ãƒƒãƒˆ' : (val > 0 ? `èºå¯„ã‚Š (+${val})` : `é¬±å¯„ã‚Š (${val})`);
		document.getElementById('moodValueDisplay').textContent = `${label} (${val})`;
		document.getElementById('moodValueDisplay').style.color = getMoodColor(val);
	}

	function renderCalendar() {
		const grid = document.getElementById('calendarGrid');
		const year = currentDisplayDate.getFullYear();
		const month = currentDisplayDate.getMonth();
		document.getElementById('currentMonthLabel').textContent = `${year}å¹´ ${month + 1}æœˆ`;
		grid.innerHTML = '';

		['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => {
			const div = document.createElement('div');
			div.className = 'weekday'; div.textContent = d; grid.appendChild(div);
		});

		const firstDay = new Date(year, month, 1).getDay();
		const totalDays = new Date(year, month + 1, 0).getDate();
		for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

		const today = new Date().toISOString().split('T')[0];
		for(let d=1; d<=totalDays; d++) {
			const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
			const cell = document.createElement('div');
			cell.className = 'day-cell' + (dateKey === today ? ' day-today' : '');
			
			const num = document.createElement('div');
			num.className = 'day-number'; num.textContent = d; cell.appendChild(num);

			const data = JSON.parse(localStorage.getItem(`bipolar_app_${dateKey}`));
			if(data) {
				const ind = document.createElement('div');
				ind.className = 'mood-indicator';
				ind.style.backgroundColor = getMoodColor(data.mood);
				ind.textContent = getMoodEmoji(data.mood);
				if(data.sleepDuration) {
					const b = document.createElement('div');
					b.className = 'sleep-badge'; b.textContent = `${data.sleepDuration}h`;
					ind.appendChild(b);
				}
				cell.appendChild(ind);
			}
			cell.onclick = () => openModal(dateKey);
			grid.appendChild(cell);
		}
	}

	function renderChart() {
		const canvas = document.getElementById('moodChart');
		const ctx = canvas.getContext('2d');
		const dataList = [];
		const now = new Date();
		
		// ç›´è¿‘30æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
		for(let i=29; i>=0; i--) {
			const d = new Date(); d.setDate(now.getDate() - i);
			const key = d.toISOString().split('T')[0];
			const val = JSON.parse(localStorage.getItem(`bipolar_app_${key}`)) || { mood: 0, sleepDuration: 0 };
			dataList.push({ label: d.getDate(), mood: val.mood, sleep: parseFloat(val.sleepDuration || 0) });
		}

		// æç”»è¨­å®š
		const padding = 30;
		const width = canvas.width = canvas.offsetWidth;
		const height = canvas.height = 250;
		const plotW = width - padding * 2;
		const plotH = height - padding * 2;
		const stepX = plotW / (dataList.length - 1);

		ctx.clearRect(0,0,width,height);

		// ã‚¬ã‚¤ãƒ‰ç·š
		ctx.strokeStyle = '#eee'; ctx.beginPath();
		ctx.moveTo(padding, height/2); ctx.lineTo(width-padding, height/2); ctx.stroke();

		// ç¡çœ ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
		dataList.forEach((d, i) => {
			const x = padding + i * stepX;
			const barH = (d.sleep / 15) * plotH; // 15æ™‚é–“ã‚’MAXã¨ã™ã‚‹
			ctx.fillStyle = '#eee';
			ctx.fillRect(x - 2, height - padding - barH, 4, barH);
		});

		// æ°—åˆ†ï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰
		ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
		ctx.lineWidth = 3; ctx.beginPath();
		dataList.forEach((d, i) => {
			const x = padding + i * stepX;
			const y = (height/2) - (d.mood / 10) * plotH; // -5ã€œ+5ã®ç¯„å›²
			if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
		});
		ctx.stroke();

		// ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
		const avgSleep = (dataList.reduce((a, b) => a + b.sleep, 0) / dataList.filter(d => d.sleep > 0).length || 0).toFixed(1);
		const moodFluc = Math.max(...dataList.map(d => d.mood)) - Math.min(...dataList.map(d => d.mood));
		
		let advice = `æœ€è¿‘ã®å¹³å‡ç¡çœ æ™‚é–“ã¯ **${avgSleep}æ™‚é–“** ã§ã™ã­ã€‚`;
		if(avgSleep < 5) advice += " ç¡çœ ãŒã‹ãªã‚ŠçŸ­ããªã£ã¦ã„ã¾ã™ã€‚èºè»¢ã®ã‚µã‚¤ãƒ³ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€æ„è­˜ã—ã¦æ¨ªã«ãªã‚Šã¾ã—ã‚‡ã†ã€‚ğŸ›Œ";
		else if(moodFluc > 4) advice += " æ°—åˆ†ã®æ³¢ãŒå¤§ãããªã£ã¦ã„ã¾ã™ã€‚åˆºæ¿€ã‚’é¿ã‘ã¦ã€ãƒ«ãƒ¼ãƒãƒ³ã‚’å®ˆã‚‹ã®ãŒå‰ã§ã™ã€‚ğŸŒŠ";
		else advice += " æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã¾ã™ï¼ã“ã®èª¿å­ã§è‡ªåˆ†ã‚’åŠ´ã‚ã£ã¦ã‚ã’ã¦ãã ã•ã„ã€‚âœ¨";
		
		document.getElementById('insightText').innerHTML = advice;
	}

	function openModal(dateKey) {
		selectedDateStr = dateKey;
		const data = JSON.parse(localStorage.getItem(`bipolar_app_${dateKey}`));
		document.getElementById('entryModal').style.display = 'flex';
		document.getElementById('modalDateLabel').textContent = dateKey;
		
		const mood = data ? data.mood : 0;
		const start = data ? data.sleepStart : 1500;
		const end = data ? data.sleepEnd : 1980;
		
		document.getElementById('moodRange').value = mood;
		updateMoodLabel(mood);
		document.getElementById('sleepStartRange').value = start;
		document.getElementById('sleepEndRange').value = end;
		updateSleepDisplay(start, end);
		document.getElementById('memoInput').value = data ? data.memo : '';
	}

	function saveEntry() {
		const data = {
			mood: parseInt(document.getElementById('moodRange').value),
			sleepStart: parseInt(document.getElementById('sleepStartRange').value),
			sleepEnd: parseInt(document.getElementById('sleepEndRange').value),
			sleepDuration: document.getElementById('sleepDurationDisplay').textContent,
			memo: document.getElementById('memoInput').value,
			timestamp: new Date().toISOString()
		};
		localStorage.setItem(`bipolar_app_${selectedDateStr}`, JSON.stringify(data));
		closeModal(); renderCalendar();
	}

	function closeModal() { document.getElementById('entryModal').style.display = 'none'; }
	function changeMonth(s) { currentDisplayDate.setMonth(currentDisplayDate.getMonth() + s); renderCalendar(); }
	function getMoodColor(v) { return v === 0 ? '#9e9e9e' : (v > 0 ? (v >= 3 ? '#ff1744' : '#ff8a80') : (v <= -3 ? '#2979ff' : '#90caf9')); }
	function getMoodEmoji(v) { if(v>=4)return'ğŸ”¥';if(v>=2)return'ğŸ˜¤';if(v>=1)return'ğŸ™‚';if(v===0)return'ğŸ˜';if(v>=-1)return'â˜ï¸';if(v>=-3)return'ğŸ’§';return'â˜”ï¸'; }
	
	function exportData() {
		let csv = "Date,Mood,SleepDuration,Memo\n";
		const keys = Object.keys(localStorage).filter(k => k.startsWith('bipolar_app_')).sort();
		keys.forEach(k => {
			const d = JSON.parse(localStorage.getItem(k));
			csv += `${k.replace('bipolar_app_','')},${d.mood},${d.sleepDuration},"${(d.memo||'').replace(/"/g,'""')}"\n`;
		});
		const blob = new Blob([csv], { type: 'text/csv' });
		const url = window.URL.createObjectURL(blob);
		const a = document.createElement('a'); a.href = url; a.download = 'mood_data.csv'; a.click();
	}
</script>
</body>
</html>